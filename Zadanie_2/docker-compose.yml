services:
  postgres:
    image: postgres:16
    container_name: lf_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-langflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-langflow}
      POSTGRES_DB: ${POSTGRES_DB:-lankovacka}
    ports:
      - "5432:5432"
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
      - ./services/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-langflow} -d ${POSTGRES_DB:-lankovacka}"]
      interval: 5s
      timeout: 3s
      retries: 20

  chromadb:
    image: chromadb/chroma:latest
    container_name: lf_chromadb
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    ports:
      - "8000:8000"
    volumes:
      - ./.data/chroma:/chroma/chroma
    healthcheck:
      test: ["CMD-SHELL", "chroma --version >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  ollama:
    image: ollama/ollama:latest
    container_name: lf_ollama
    ports:
      - "11434:11434"
    volumes:
      - ./.data/ollama:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "ollama list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  ollama-init:
    image: ollama/ollama:latest
    container_name: lf_ollama_init
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      OLLAMA_HOST: http://ollama:11434
    entrypoint: ["/bin/sh", "-lc"]
    command: "ollama pull qwen2.5:3b-instruct && ollama pull llama3.2:3b && ollama pull nomic-embed-text"
    restart: "no"

  langflow:
    image: langflowai/langflow:latest
    container_name: lf_langflow
    depends_on:
      - postgres
      - chromadb
      - ollama
    environment:
      # LangFlow internal persistence (keep it simple; SQLite inside container)
      LANGFLOW_HOST: 0.0.0.0
      LANGFLOW_PORT: ${LANGFLOW_PORT:-7860}

      # Convenience envs used in setup notes / components
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-lankovacka}
      POSTGRES_USER: ${POSTGRES_USER:-langflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-langflow}

      CHROMA_HOST: ${CHROMA_HOST:-chromadb}
      CHROMA_PORT: ${CHROMA_PORT:-8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-kb_lankovacka}

      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.2:3b}

    ports:
      - "${LANGFLOW_PORT:-7860}:7860"
    volumes:
      - ./.data/langflow:/data
      - ./app/langflow:/opt/langflow_assets:ro

  # Optional - DB viewer
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lf_pgadmin
    profiles: ["optional"]
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./.data/pgadmin:/var/lib/pgadmin

